'use client';

import { useState, useEffect } from 'react';
import { 
  Shield, 
  ShieldCheck,
  Server,
  Cpu,
  Users,
  Building,
  KeyRound,
  Database,
  BarChart3,
  Activity,
  AlertCircle,
  CheckCircle,
  Clock,
  RefreshCw,
  Settings,
  Package,
  ChevronRight,
  ChevronLeft,
  Menu,
  FileText // Rapor ikonu için eklendi
} from 'lucide-react';
import { createClient } from '@/lib/supabase/client';
import YoneticiIstatistikler from './YoneticiIstatistikler';
import KullaniciYonetimi from './KullaniciYonetimi';
import OdaYonetimi from './OdaYonetimi';
import YetkiYonetimi from './YetkiYonetimi';
import DolapYonetimi from '@/components/DolapYonetimi';
import RaporAlma from '@/components/rapor/RaporAlma'; // Rapor component'i eklendi

const supabase = createClient();

interface YoneticiDashboardProps {
  currentUserId?: number;
}

// TabType'a 'raporlar' eklendi
type TabType = 'dashboard' | 'kullanicilar' | 'odalar' | 'yetkiler' | 'loglar' | 'sistem' | 'dolaplar' | 'raporlar';

export default function YoneticiDashboard({ currentUserId }: YoneticiDashboardProps) {
  const [activeTab, setActiveTab] = useState<TabType>('dashboard');
  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
  const [mobileOpen, setMobileOpen] = useState(false);

  const [sistemDurumu, setSistemDurumu] = useState({
    database: 'connected',
    api: 'online',
    uptime: '99.9%',
    lastBackup: '2 saat önce',
    activeSessions: 0,
    memoryUsage: '45%',
    cpuUsage: '12%',
    totalDolap: 24,
    activeDolap: 15,
    dolapDoluluk: '68%'
  });

  const [loading, setLoading] = useState(false);
  const [refreshKey, setRefreshKey] = useState(0);

  useEffect(() => {
    checkSystemStatus();
  }, []);

  const checkSystemStatus = async () => {
    try {
      setLoading(true);

      const { error } = await supabase
        .from('kullanicilar')
        .select('count')
        .limit(1)
        .single();

      const databaseStatus = error ? 'disconnected' : 'connected';
      const apiStatus = 'online';

      const { count: activeSessions } = await supabase
        .from('sistem_loglari')
        .select('*', { count: 'exact', head: true })
        .gte('created_at', new Date(Date.now() - 5 * 60 * 1000).toISOString());

      const { data: dolapData } = await supabase
        .from('dolaplar')
        .select('id, aktif, doluluk_orani');

      const totalDolap = dolapData?.length || 0;
      const activeDolap = dolapData?.filter(d => d.aktif).length || 0;
      const avgDoluluk = dolapData && dolapData.length > 0 
        ? Math.round(dolapData.reduce((sum, d) => sum + (d.doluluk_orani || 0), 0) / dolapData.length)
        : 0;

      setSistemDurumu(prev => ({
        ...prev,
        database: databaseStatus,
        api: apiStatus,
        activeSessions: activeSessions || 0,
        totalDolap,
        activeDolap,
        dolapDoluluk: `${avgDoluluk}%`
      }));
    } catch (error) {
      console.error('Sistem durumu kontrol hatası:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleRefresh = () => {
    setRefreshKey(prev => prev + 1);
    checkSystemStatus();
  };

  const tabContents = {
    dashboard: (
      <div className="space-y-8">
        <YoneticiIstatistikler refreshTrigger={refreshKey % 2 === 0} />
      </div>
    ),
    kullanicilar: (
      <KullaniciYonetimi
        refreshTrigger={refreshKey % 2 === 0}
        onKullaniciEklendi={() => setRefreshKey(prev => prev + 1)}
        onKullaniciGuncellendi={() => setRefreshKey(prev => prev + 1)}
      />
    ),
    odalar: (
      <OdaYonetimi
        refreshTrigger={refreshKey % 2 === 0}
        onOdaEklendi={() => setRefreshKey(prev => prev + 1)}
        onOdaGuncellendi={() => setRefreshKey(prev => prev + 1)}
      />
    ),
    yetkiler: (
      <YetkiYonetimi
        refreshTrigger={refreshKey % 2 === 0}
        onYetkiDegisti={() => setRefreshKey(prev => prev + 1)}
      />
    ),
    loglar: (
      <div className="p-8 text-center text-gray-500">Loglar yakında...</div>
    ),
    sistem: (
      <div className="p-8 text-center text-gray-500">Sistem ayarları yakında...</div>
    ),
    dolaplar: (
      <DolapYonetimi isAdmin={true} />
    ),
    raporlar: (
      <RaporAlma />
    )
  };

  const tabs = [
    { id: 'dashboard', label: 'Dashboard', icon: BarChart3 },
    { id: 'dolaplar', label: 'Dolaplar', icon: Package },
    { id: 'kullanicilar', label: 'Kullanıcılar', icon: Users },
    { id: 'odalar', label: 'Odalar', icon: Building },
    { id: 'yetkiler', label: 'Yetkiler', icon: KeyRound },
    { id: 'raporlar', label: 'Raporlar', icon: FileText }, // Raporlar eklendi
    { id: 'loglar', label: 'Loglar', icon: Database },
    { id: 'sistem', label: 'Sistem', icon: Settings },
  ] as const;

  return (
    <div className="flex min-h-screen bg-gray-50 text-gray-900">
      {/* Mobile Overlay */}
      {mobileOpen && (
        <div
          onClick={() => setMobileOpen(false)}
          className="fixed inset-0 bg-black/30 z-30 md:hidden"
        />
      )}

      {/* Sidebar */}
      <aside
        className={`fixed md:static z-30 h-screen bg-white border-r border-gray-200 transition-all
        ${sidebarCollapsed ? 'w-16' : 'w-64'}
        ${mobileOpen ? 'left-0' : '-left-64'} md:left-0`}
      >
        <div className="h-full flex flex-col">
          <div className="h-16 flex items-center justify-between px-3 border-b">
            {!sidebarCollapsed && (
              <div className="flex items-center gap-2 font-bold">
                <ShieldCheck className="h-6 w-6 text-blue-600" />
                Yönetici
              </div>
            )}
            <button
              onClick={() => setSidebarCollapsed(p => !p)}
              className="hidden md:flex p-2 hover:bg-gray-100 rounded"
            >
              {sidebarCollapsed ? <ChevronRight /> : <ChevronLeft />}
            </button>
            <button
              onClick={() => setMobileOpen(false)}
              className="md:hidden p-2 hover:bg-gray-100 rounded"
            >
              <ChevronLeft />
            </button>
          </div>

          <nav className="flex-1 p-2 space-y-1">
            {tabs.map(tab => {
              const Icon = tab.icon;
              const isActive = activeTab === tab.id;
              return (
                <button
                  key={tab.id}
                  onClick={() => {
                    setActiveTab(tab.id as TabType);
                    setMobileOpen(false);
                  }}
                  className={`w-full flex items-center gap-3 px-3 py-2 rounded-lg transition
                    ${isActive ? 'bg-blue-50 text-blue-600' : 'hover:bg-gray-100 text-gray-700'}
                  `}
                >
                  <Icon className="h-5 w-5" />
                  {!sidebarCollapsed && <span>{tab.label}</span>}
                </button>
              );
            })}
          </nav>
        </div>
      </aside>

      {/* Main */}
      <main className="flex-1 w-full">
        {/* Top Bar */}
        <div className="h-16 flex items-center justify-between px-4 border-b bg-white sticky top-0 z-20">
          <div className="flex items-center gap-2">
            <button
              className="md:hidden p-2 hover:bg-gray-100 rounded"
              onClick={() => setMobileOpen(true)}
            >
              <Menu />
            </button>
            <div className="text-sm text-gray-500">
              Yönetici Paneli / {tabs.find(t => t.id === activeTab)?.label || activeTab}
            </div>
          </div>
          <button
            onClick={handleRefresh}
            className="px-3 py-1.5 bg-blue-600 text-white rounded-lg text-sm flex items-center gap-2"
          >
            <RefreshCw className={`h-4 w-4 ${loading ? 'animate-spin' : ''}`} />
            Yenile
          </button>
        </div>

        {/* Content */}
        <div className="p-4 md:p-6 w-full">
          {tabContents[activeTab]}
        </div>
      </main>
    </div>
  );
}